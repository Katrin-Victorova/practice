//async / await –≤ JavaScript

/* 0) –ó–ê–ß–ï–ú –ù–£–ñ–ï–ù async / await (–≥–ª–∞–≤–Ω–∞—è –º—ã—Å–ª—å)
----------------------------------------------------------------------------
async/await ‚Äî —ç—Ç–æ –°–ò–ù–¢–ê–ö–°–ò–ß–ï–°–ö–ò–ô –°–ê–•–ê–† –Ω–∞–¥ Promise.

–û–Ω –ù–ï –¥–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—É—é –º–µ—Ö–∞–Ω–∏–∫—É –≤ JS.
–û–Ω –ø—Ä–æ—Å—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–∏—Å–∞—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∫–æ–¥:
- –±–µ–∑ .then().then().catch()
- ‚Äú–∫–∞–∫ –±—É–¥—Ç–æ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ‚Äù
- –Ω–æ –ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º –≤—Å—ë —Ä–∞–≤–Ω–æ Promise + Event Loop

–ö–ª—é—á–µ–≤–∞—è –∏–¥–µ—è:
üëâ async/await = –£–î–û–ë–ù–´–ô –°–ò–ù–¢–ê–ö–°–ò–° –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Promise

----------------------------------------------------------------------------
1) async ‚Äî —á—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç
async —Å—Ç–∞–≤–∏—Ç—Å—è –ø–µ—Ä–µ–¥ —Ñ—É–Ω–∫—Ü–∏–µ–π.

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç:
1Ô∏è‚É£ —Ñ—É–Ω–∫—Ü–∏—è –í–°–ï–ì–î–ê –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç Promise
2Ô∏è‚É£ –ª—é–±–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ —Ç—ã return ‚Äî –æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è –≤ Promise.resolve
3Ô∏è‚É£ –≤—ã–±—Ä–æ—à–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ = Promise.reject */

async function foo() {
	return 10;
}

// —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω–æ:
function fooEquivalent() {
	return Promise.resolve(10);
}

foo().then(console.log); // 10

/* 2) await ‚Äî —á—Ç–æ –æ–Ω –¥–µ–ª–∞–µ—Ç –ù–ê –°–ê–ú–û–ú –î–ï–õ–ï
----------------------------------------------------------------------------
await:
- –ø—Ä–∏–Ω–∏–º–∞–µ—Ç Promise
- ‚Äú–∂–¥—ë—Ç‚Äù –µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
- –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç value, –µ—Å–ª–∏ fulfilled
- –±—Ä–æ—Å–∞–µ—Ç –æ—à–∏–±–∫—É, –µ—Å–ª–∏ rejected

‚ùó –í–ê–ñ–ù–û:
await –ù–ï –±–ª–æ–∫–∏—Ä—É–µ—Ç JS
await ‚Äú—Å—Ç–∞–≤–∏—Ç —Ñ—É–Ω–∫—Ü–∏—é –Ω–∞ –ø–∞—É–∑—É‚Äù –∏ –æ—Ç–¥–∞—ë—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Event Loop

–ü–æ–¥ –∫–∞–ø–æ—Ç–æ–º:
- –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ async-—Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–∏–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
- –æ—Å—Ç–∞–ª—å–Ω–æ–π JS –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- –∫–æ–≥–¥–∞ Promise resolved ‚Üí —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è */

async function example() {
	console.log('start');

	const value = await Promise.resolve(42);
	// ‚¨Ü –∑–¥–µ—Å—å —Ñ—É–Ω–∫—Ü–∏—è –ü–†–ò–û–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–¢–°–Ø

	console.log('value:', value);

	console.log('end');
}

example();

/*
–ü–æ—Ä—è–¥–æ–∫:
start
value: 42
end
*/

/* 3) await –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¢–û–õ–¨–ö–û –≤–Ω—É—Ç—Ä–∏ async
----------------------------------------------------------------------------
‚ùå –¢–∞–∫ –Ω–µ–ª—å–∑—è:
const value = await Promise.resolve(1);

‚úî –¢–∞–∫ –º–æ–∂–Ω–æ:
- –≤–Ω—É—Ç—Ä–∏ async —Ñ—É–Ω–∫—Ü–∏–∏
- –∏–ª–∏ –≤–Ω—É—Ç—Ä–∏ async IIFE */

// async IIFE ‚Äî —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
(async () => {
	const data = await Promise.resolve('ok');
	console.log(data);
})();

/* 4) –û—à–∏–±–∫–∏ –∏ try / catch
----------------------------------------------------------------------------
–í–ê–ñ–ù–û–ï –ü–†–ê–í–ò–õ–û:
await + rejected Promise = –≤—ã–±—Ä–æ—à–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞

–ü–æ—ç—Ç–æ–º—É:
- .catch() –∑–∞–º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ try/catch
- finally —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–∞–∫ –∂–µ, –∫–∞–∫ –≤ Promise.finally  */

async function loadData() {
	try {
		const data = await Promise.reject('ERROR');
		console.log(data); // –Ω–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è
	} catch (err) {
		console.log('–ø–æ–π–º–∞–ª–∏ –æ—à–∏–±–∫—É:', err);
	} finally {
		console.log('–≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –≤—Å–µ–≥–¥–∞');
	}
}

loadData();

/* 5) async / await –∏ Promise API ‚Äî –≤–º–µ—Å—Ç–µ
----------------------------------------------------------------------------
Promise.all / race / any / allSettled
‚Üí –í–°–Å –≠–¢–û –ú–û–ñ–ù–û await-–∏—Ç—å

await –∂–¥—ë—Ç –û–î–ò–ù Promise
–∞ Promise API –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –û–î–ò–ù Promise */

async function loadAll() {
	const results = await Promise.all([
		Promise.resolve(1),
		Promise.resolve(2),
		Promise.resolve(3),
	]);

	console.log(results); // [1, 2, 3]
}

loadAll();

/* 6) –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ vs –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ (–û–ß–ï–ù–¨ –í–ê–ñ–ù–û)
----------------------------------------------------------------------------
‚ùå –ß–∞—Å—Ç–∞—è –æ—à–∏–±–∫–∞ –Ω–æ–≤–∏—á–∫–æ–≤: */

async function wrong() {
	const a = await fetch('/a'); // –∂–¥—ë–º
	const b = await fetch('/b'); // –∂–¥—ë–º
	const c = await fetch('/c'); // –∂–¥—ë–º
}
// –ó–¥–µ—Å—å –∑–∞–ø—Ä–æ—Å—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ü–û –û–ß–ï–†–ï–î–ò

/* ‚úî –ü—Ä–∞–≤–∏–ª—å–Ω–æ (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ): */

async function correct() {
	const promiseA = fetch('/a');
	const promiseB = fetch('/b');
	const promiseC = fetch('/c');

	const [a, b, c] = await Promise.all([promiseA, promiseB, promiseC]);
}

/* –°—Ö–µ–º–∞:
1) –∑–∞–ø—Ä–æ—Å—ã —Å—Ç–∞—Ä—Ç—É—é—Ç —Å—Ä–∞–∑—É
2) await –∂–¥—ë—Ç –∏—Ö –≤–º–µ—Å—Ç–µ */

/* 7) async-—Ñ—É–Ω–∫—Ü–∏—è –≤ Event Loop (–≤–∞–∂–Ω–æ –¥–ª—è middle)
----------------------------------------------------------------------------
–ö–æ–≥–¥–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è async-—Ñ—É–Ω–∫—Ü–∏—è:
- –∫–æ–¥ –î–û –ø–µ—Ä–≤–æ–≥–æ await ‚Üí –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –°–ò–ù–•–†–û–ù–ù–û
- –∫–æ–¥ –ü–û–°–õ–ï await ‚Üí –ø–æ–ø–∞–¥–∞–µ—Ç –≤ MICROTASK

–¢–æ –µ—Å—Ç—å:
await ‚âà then (–ø–æ –æ—á–µ—Ä–µ–¥—è–º) */

console.log('start');

(async () => {
	console.log('inside async before await');

	await Promise.resolve();

	console.log('inside async after await');
})();

console.log('end');

/* –ü–æ—Ä—è–¥–æ–∫:
start
inside async before await
end
inside async after await */

/* 8) async / await vs then ‚Äî —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç—å
----------------------------------------------------------------------------
–≠—Ç–∏ –¥–≤–∞ –∫–æ–¥–∞ –¥–µ–ª–∞—é—Ç –û–î–ù–û –ò –¢–û –ñ–ï: */

// —á–µ—Ä–µ–∑ then
function withThen() {
	return fetch('/data')
		.then(res => res.json())
		.then(data => data.value);
}

// —á–µ—Ä–µ–∑ async/await
async function withAwait() {
	const res = await fetch('/data');
	const data = await res.json();
	return data.value;
}

/* –†–∞–∑–Ω–∏—Ü–∞:
- await —á–∏—Ç–∞–µ—Ç—Å—è –ø—Ä–æ—â–µ
- then –∏–Ω–æ–≥–¥–∞ —É–¥–æ–±–Ω–µ–µ –¥–ª—è —Ü–µ–ø–æ—á–µ–∫ –∏ stream-–ø–æ–¥—Ö–æ–¥–∞ */

/* 9) –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏
----------------------------------------------------------------------------
‚ùå await –≤–Ω–µ async
‚ùå –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ await –≤–º–µ—Å—Ç–æ Promise.all
‚ùå –∑–∞–±—ã—Ç—å try/catch
‚ùå –¥—É–º–∞—Ç—å, —á—Ç–æ await = –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤—Å–µ–≥–æ JS
‚ùå –∑–∞–±—ã—Ç—å, —á—Ç–æ async –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç Promise

============================================================================
10) –ö–û–†–û–¢–ö–û: –ø—Ä–∞–≤–∏–ª–∞, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞–¥–æ –ó–ê–ü–û–ú–ù–ò–¢–¨
----------------------------------------------------------------------------
1Ô∏è‚É£ async —Ñ—É–Ω–∫—Ü–∏—è –í–°–ï–ì–î–ê –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç Promise
2Ô∏è‚É£ return value ‚Üí Promise.resolve(value)
3Ô∏è‚É£ throw error ‚Üí Promise.reject(error)
4Ô∏è‚É£ await –∂–¥—ë—Ç Promise, –Ω–æ –ù–ï –±–ª–æ–∫–∏—Ä—É–µ—Ç JS
5Ô∏è‚É£ –∫–æ–¥ –ø–æ—Å–ª–µ await = –º–∏–∫—Ä–æ—Ç–∞—Å–∫–∞
6Ô∏è‚É£ –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç–∏ ‚Äî Promise.all
7Ô∏è‚É£ try/catch –∑–∞–º–µ–Ω—è–µ—Ç .catch  */

// 1
console.log('Start'); // (1)

setTimeout(() => console.log('Timeout'), 0); // (2) macrotask

Promise.resolve().then(() => console.log('Promise')); // (3) microtask

async function run() {
	console.log('Async start'); // (4) sync –≤–Ω—É—Ç—Ä–∏ async –¥–æ await
	await Promise.resolve(); // (5) –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ -> microtask
	console.log('Async end'); // (7) microtask
}

run(); // (4)(5)

console.log('End'); // (6)

// –í—ã–≤–æ–¥–∏—Ç
// Start ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
// Async start ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ (–¥–æ await)
// End ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
// ‚úÖ —Ç–æ–ª—å–∫–æ —Ç–µ–ø–µ—Ä—å —Å—Ç–µ–∫ –ø—É—Å—Ç ‚Üí –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –º–∏–∫—Ä–æ—Ç–∞—Å–∫–∏:
// Promise
// Async end
// –∞ –ø–æ—Ç–æ–º –º–∞–∫—Ä–æ—Ç–∞—Å–∫–∏:
// Timeout

// 2
async function foo() {
	// —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
	console.log('A');

	setTimeout(() => console.log('B'), 0);

	await Promise.resolve();

	console.log('C');
}

console.log('Start');

foo(); // –¢–µ–ø–µ—Ä—å —Ñ—É–Ω–∫—Ü–∏—è —Ä–µ–∞–ª—å–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è.

console.log('End');

// async –Ω–µ –¥–µ–ª–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ–π.
// –û–Ω–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –º–æ–º–µ–Ω—Ç –≤—ã–∑–æ–≤–∞.
// –ò –¥–æ –ø–µ—Ä–≤–æ–≥–æ await —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –æ–±—ã—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è.

// 3 - await –Ω–µ –ø–µ—á–∞—Ç–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ. –û–Ω —Ç–æ–ª—å–∫–æ ‚Äú–ø–æ–ª—É—á–∞–µ—Ç‚Äù –µ–≥–æ.
console.log('Start');

// async function test() {
//     await 42;
//     console.log("After await");
// }
async function test() {
	const x = await 42; // –ù—É–∂–Ω–æ —è–≤–Ω–æ –≤—ã–≤–µ—Å—Ç–∏
	console.log(x);
	console.log('After await');
}

test();

console.log('End');

// 4
async function test() {
	console.log('A');

	await new Promise(resolve => {
		console.log('B'); // new Promise(executor) –∑–∞–ø—É—Å–∫–∞–µ—Ç executor –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
		// B –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ executor-–µ Promise, –∞ executor –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å—Ä–∞–∑—É, —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, –≤ –º–æ–º–µ–Ω—Ç new Promise(...)
		resolve();
	});

	console.log('C'); // —Å—Ç–∞–≤–∏—Ç—Å—è –≤ microtask
}

console.log('Start');

test();

console.log('End');

// 5
// 1Ô∏è‚É£ –°—Ç–∞–≤–∏–º —Ç–∞–π–º–µ—Ä ‚Üí —ç—Ç–æ MACROTASK
// –û–Ω –ù–ï –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è —Å–µ–π—á–∞—Å, –∞ —Ç–æ–ª—å–∫–æ –ü–û–°–õ–ï:
// - –≤—Å–µ–≥–æ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞
// - –≤—Å–µ—Ö –º–∏–∫—Ä–æ—Ç–∞—Å–æ–∫
setTimeout(() => console.log('T1'), 0);

async function foo() {
	// 2Ô∏è‚É£ –°–ò–ù–•–†–û–ù–ù–û –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –≤—ã–∑–æ–≤–µ foo()
	console.log('A');

	// 3Ô∏è‚É£ await –≤—Å–µ–≥–¥–∞ –¥–µ–ª–∞–µ—Ç –ü–ê–£–ó–£,
	// –¥–∞–∂–µ –µ—Å–ª–∏ Promise —É–∂–µ resolved
	// ‚Üì
	// –í—Å—ë, —á—Ç–æ –ù–ò–ñ–ï, –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–æ
	// –∫–∞–∫ –û–î–ù–ê –ú–ò–ö–†–û–¢–ê–°–ö–ê (resume foo)
	await Promise.resolve();

	// 6Ô∏è‚É£ –≠—Ç–æ—Ç setTimeout –±—É–¥–µ—Ç –ø–æ—Å—Ç–∞–≤–ª–µ–Ω
	// –¢–û–õ–¨–ö–û –∫–æ–≥–¥–∞ –º–∏–∫—Ä–æ—Ç–∞—Å–∫–∞ resume foo –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è
	// ‚Üí —ç—Ç–æ MACROTASK
	setTimeout(() => console.log('T2'), 0);

	// 7Ô∏è‚É£ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –í–ù–£–¢–†–ò –º–∏–∫—Ä–æ—Ç–∞—Å–∫–∏ resume foo
	console.log('B');
}

// 4Ô∏è‚É£ –í—ã–∑—ã–≤–∞–µ–º async-—Ñ—É–Ω–∫—Ü–∏—é
// –ö–æ–¥ –î–û await –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –°–†–ê–ó–£
foo();

// 5Ô∏è‚É£ –°—Ç–∞–≤–∏–º –µ—â—ë –æ–¥–Ω—É –ú–ò–ö–†–û–¢–ê–°–ö–£
// –û–Ω–∞ –ø–æ–ø–∞–¥—ë—Ç –í –û–ß–ï–†–ï–î–¨ –ü–û–°–õ–ï resume foo,
// –ø–æ—Ç–æ–º—É —á—Ç–æ —ç—Ç–∞ —Å—Ç—Ä–æ–∫–∞ –∏–¥—ë—Ç –ù–ò–ñ–ï –≤ –∫–æ–¥–µ
Promise.resolve().then(() => console.log('P'));

A; // —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
B; // –º–∏–∫—Ä–æ—Ç–∞—Å–∫–∞ resume foo
P; // —Å–ª–µ–¥—É—é—â–∞—è –º–∏–∫—Ä–æ—Ç–∞—Å–∫–∞
T1; // –º–∞–∫—Ä–æ—Ç–∞—Å–∫–∞
T2; // –º–∞–∫—Ä–æ—Ç–∞—Å–∫–∞ (–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –ø–æ–∑–∂–µ)
