// Fetch API, HTTP –∏ —Ä–∞–±–æ—Ç–∞ —Å Web API

/* 0Ô∏è‚É£ –ß–¢–û –¢–ê–ö–û–ï API (–æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–æ)
----------------------------------------------------------------------------
API (Application Programming Interface) ‚Äî
—ç—Ç–æ ‚Äú–¥–æ–≥–æ–≤–æ—Ä‚Äù, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –æ–¥–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞
–º–æ–∂–µ—Ç –æ–±—â–∞—Ç—å—Å—è —Å –¥—Ä—É–≥–æ–π.

–í –≤–µ–±–µ —á–∞—â–µ –≤—Å–µ–≥–æ:
- –±—Ä–∞—É–∑–µ—Ä / frontend
- –æ–±—â–∞–µ—Ç—Å—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º
- —á–µ—Ä–µ–∑ HTTP-–∑–∞–ø—Ä–æ—Å—ã
- –∏—Å–ø–æ–ª—å–∑—É—è Web API (fetch, headers, etc.)
============================================================================
1Ô∏è‚É£ HTTP ‚Äî –ö–ê–ö –ë–†–ê–£–ó–ï–† –û–ë–©–ê–ï–¢–°–Ø –° –°–ï–†–í–ï–†–û–ú
----------------------------------------------------------------------------
HTTP-–∑–∞–ø—Ä–æ—Å —Å–æ—Å—Ç–æ–∏—Ç –∏–∑:
1) METHOD  ‚Äî —á—Ç–æ —Ö–æ—Ç–∏–º —Å–¥–µ–ª–∞—Ç—å
2) URL     ‚Äî –∫ –∫–∞–∫–æ–º—É —Ä–µ—Å—É—Ä—Å—É
3) HEADERS ‚Äî –º–µ—Ç–∞-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
4) BODY    ‚Äî –¥–∞–Ω–Ω—ã–µ (–Ω–µ –≤—Å–µ–≥–¥–∞)
----------------------------------------------------------------------------
–û—Å–Ω–æ–≤–Ω—ã–µ HTTP-–º–µ—Ç–æ–¥—ã:
GET     ‚Äî –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
POST    ‚Äî —Å–æ–∑–¥–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
PUT     ‚Äî –∑–∞–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
PATCH   ‚Äî —á–∞—Å—Ç–∏—á–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å
DELETE  ‚Äî —É–¥–∞–ª–∏—Ç—å
============================================================================
2Ô∏è‚É£ fetch ‚Äî –ß–¢–û –≠–¢–û –ò –ö–ê–ö –†–ê–ë–û–¢–ê–ï–¢
----------------------------------------------------------------------------
fetch ‚Äî —ç—Ç–æ Web API –±—Ä–∞—É–∑–µ—Ä–∞ (–ù–ï —á–∞—Å—Ç—å JS —è–∑—ã–∫–∞!)

fetch(url, options) ‚Üí
–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç Promise<Response>

–í–ê–ñ–ù–û:
‚ùó fetch –ù–ï –ø–∞–¥–∞–µ—Ç –Ω–∞ 4xx / 5xx
‚ùó fetch –ø–∞–¥–∞–µ—Ç –¢–û–õ–¨–ö–û –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å —Å–µ—Ç—å—é
============================================================================
3Ô∏è‚É£ –ü–†–û–°–¢–û–ô GET –ó–ê–ü–†–û–°
---------------------------------------------------------------------------- */

fetch('https://jsonplaceholder.typicode.com/posts')
	.then(response => {
		// response ‚Äî —ç—Ç–æ –æ–±—ä–µ–∫—Ç Response
		// –∑–¥–µ—Å—å –ù–ï–¢ –¥–∞–Ω–Ω—ã—Ö, —Ç–æ–ª—å–∫–æ –ø–æ—Ç–æ–∫
		return response.json(); // ‚Üê —Ç–æ–∂–µ Promise
	})
	.then(data => {
		// data ‚Äî —É–∂–µ JS-–æ–±—ä–µ–∫—Ç
		console.log(data);
	})
	.catch(error => {
		// —Å—é–¥–∞ –ø–æ–ø–∞–¥—ë–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏:
		// ‚ùå –Ω–µ—Ç —Å–µ—Ç–∏
		// ‚ùå CORS
		// ‚ùå aborted
		console.error(error);
	});

/* ============================================================================
4Ô∏è‚É£ Response ‚Äî –ß–¢–û –í–ù–£–¢–†–ò
----------------------------------------------------------------------------
response.status      ‚Üí HTTP-–∫–æ–¥ (200, 404, 500)
response.ok          ‚Üí true –µ—Å–ª–∏ 200‚Äì299
response.headers     ‚Üí –∑–∞–≥–æ–ª–æ–≤–∫–∏
response.json()      ‚Üí –ø–∞—Ä—Å–∏—Ç JSON
response.text()      ‚Üí —Ç–µ–∫—Å—Ç
response.blob()      ‚Üí —Ñ–∞–π–ª
response.arrayBuffer()

–í–ê–ñ–ù–û:
body –º–æ–∂–Ω–æ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –¢–û–õ–¨–ö–û –û–î–ò–ù –†–ê–ó
============================================================================
5Ô∏è‚É£ –û–ë–†–ê–ë–û–¢–ö–ê HTTP-–û–®–ò–ë–û–ö (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)
---------------------------------------------------------------------------- */
fetch('/api/data')
	.then(response => {
		if (!response.ok) {
			// fetch –ù–ï –∫–∏–Ω–µ—Ç –æ—à–∏–±–∫—É —Å–∞–º
			throw new Error(`HTTP error: ${response.status}`);
		}
		return response.json();
	})
	.then(data => console.log(data))
	.catch(err => console.error(err));
/* ============================================================================
6Ô∏è‚É£ POST –ó–ê–ü–†–û–° (JSON)
---------------------------------------------------------------------------- */
fetch('https://jsonplaceholder.typicode.com/posts', {
	method: 'POST',

	headers: {
		'Content-Type': 'application/json', // –≥–æ–≤–æ—Ä–∏–º —Å–µ—Ä–≤–µ—Ä—É, —á—Ç–æ —ç—Ç–æ JSON
	},

	body: JSON.stringify({
		title: '–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞',
		completed: false,
	}),
})
	.then(res => res.json())
	.then(data => console.log('–°–æ–∑–¥–∞–Ω–æ:', data))
	.catch(err => console.error(err));
/* ============================================================================
7Ô∏è‚É£ fetch + async / await (–ü–†–ê–í–ò–õ–¨–ù–´–ô –°–¢–ò–õ–¨)
---------------------------------------------------------------------------- */
async function createTask() {
	try {
		const response = await fetch('https://jsonplaceholder.typicode.com/posts', {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify({
				title: '–¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–¥–∞—á–∞',
				completed: false,
			}),
		});

		// HTTP-–æ—à–∏–±–∫–∏ –ª–æ–≤–∏–º –≤—Ä—É—á–Ω—É—é
		if (!response.ok) {
			throw new Error(`HTTP error: ${response.status}`);
		}

		const data = await response.json();
		console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
	} catch (error) {
		console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', error);
	}
}

createTask();
/* ============================================================================
8Ô∏è‚É£ AbortController ‚Äî –û–¢–ú–ï–ù–ê –ó–ê–ü–†–û–°–ê
----------------------------------------------------------------------------
–ö–æ–≥–¥–∞ –Ω—É–∂–Ω–æ:
- –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—à—ë–ª —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∑–∞–º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ä—ã–π
- —Ç–∞–π–º–∞—É—Ç

============================================================================ */
const controller = new AbortController();

fetch('/api/data', {
	signal: controller.signal, // –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Å–∏–≥–Ω–∞–ª
})
	.then(res => res.json())
	.then(data => console.log(data))
	.catch(err => {
		if (err.name === 'AbortError') {
			console.log('–ó–∞–ø—Ä–æ—Å –æ—Ç–º–µ–Ω—ë–Ω');
		} else {
			console.error(err);
		}
	});

// –æ—Ç–º–µ–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å
controller.abort();
/* ============================================================================
9Ô∏è‚É£ fetch-progress ‚Äî –ü–†–û–ì–†–ï–°–° –ó–ê–ì–†–£–ó–ö–ò
----------------------------------------------------------------------------
–í–ê–ñ–ù–û:
fetch –ù–ï –¥–∞—ë—Ç progress "–∏–∑ –∫–æ—Ä–æ–±–∫–∏" –∫–∞–∫ XHR,
–Ω—É–∂–Ω–æ —á–∏—Ç–∞—Ç—å stream –≤—Ä—É—á–Ω—É—é

(–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ–¥–∫–æ, –Ω–æ –ø–æ–ª–µ–∑–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å)
============================================================================ */
async function fetchWithProgress(url) {
	const response = await fetch(url);

	const reader = response.body.getReader();
	const contentLength = +response.headers.get('Content-Length');

	let received = 0;
	const chunks = [];

	while (true) {
		const { done, value } = await reader.read();
		if (done) break;

		chunks.push(value);
		received += value.length;

		console.log(`–ü–æ–ª—É—á–µ–Ω–æ ${received} –∏–∑ ${contentLength}`);
	}

	// —Å–æ–±–∏—Ä–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
	const blob = new Blob(chunks);
	return blob;
}
/* ============================================================================
üîü –ß–ê–°–¢–´–ï –û–®–ò–ë–ö–ò (–û–ß–ï–ù–¨ –í–ê–ñ–ù–û)
----------------------------------------------------------------------------
‚ùå –¥—É–º–∞—Ç—å, —á—Ç–æ fetch —É–ø–∞–¥—ë—Ç –Ω–∞ 404
‚ùå –∑–∞–±—ã–≤–∞—Ç—å response.ok
‚ùå –∑–∞–±—ã–≤–∞—Ç—å return response.json()
‚ùå –∑–∞–±—ã–≤–∞—Ç—å await response.json()
‚ùå –Ω–µ–≤–µ—Ä–Ω—ã–π Content-Type
‚ùå GET —Å body
‚ùå –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ try/catch
============================================================================
1Ô∏è‚É£1Ô∏è‚É£ –ú–ï–ù–¢–ê–õ–¨–ù–ê–Ø –ú–û–î–ï–õ–¨ FETCH
----------------------------------------------------------------------------
fetch ‚Üí
  Promise<Response> ‚Üí
    response.json() ‚Üí
      Promise<data>

await fetch ‚Üí
  await response.json() ‚Üí
    data
============================================================================
1Ô∏è‚É£2Ô∏è‚É£ –ó–û–õ–û–¢–´–ï –ü–†–ê–í–ò–õ–ê (–ó–ê–ü–û–ú–ù–ò–¢–¨)
----------------------------------------------------------------------------
1) fetch ‚Äî —ç—Ç–æ Web API –±—Ä–∞—É–∑–µ—Ä–∞
2) fetch –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç Promise<Response>
3) response.json() ‚Äî —Ç–æ–∂–µ Promise
4) HTTP-–æ—à–∏–±–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ä—É—á–Ω—É—é
5) async/await = —á–∏—Ç–∞–µ–º–æ—Å—Ç—å, –Ω–µ –º–∞–≥–∏—è
6) AbortController ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–ø–æ—Å–æ–± –æ—Ç–º–µ–Ω—ã
7) body —á–∏—Ç–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ */
